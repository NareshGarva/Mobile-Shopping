<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <link rel="stylesheet" href="../css/style.css"/>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <!-- Swiper CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"
  />
  <style>
    button {
      color: white;
      outline: none;
      border: none;
    }
    
    .address-card.selected {
      border: 2px solid #000 !important;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    
    .swiper-slide {
      height: auto;
    }
    
    .address-card {
      height: 100%;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .address-card:hover {
      border-color: #aaa !important;
    }
    
    .default-address-badge {
      font-size: 12px;
      padding: 2px 6px;
      background-color: #f0f0f0;
      border-radius: 10px;
      color: #333;
    }
    
    .order-item {
      display: flex;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    
    .order-item-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      margin-right: 10px;
    }
    
    .order-item-details {
      flex-grow: 1;
    }
    
    .order-item-price {
      font-weight: bold;
      text-align: right;
    }
    
    .order-summary {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      background-color: white;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .summary-total {
      font-weight: bold;
      border-top: 1px solid #ddd;
      padding-top: 10px;
      margin-top: 10px;
    }
    
    #allUserAddresses .swiper-slide,
    #billingAddresses .swiper-slide {
      height: auto;
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 767px) {
      .container {
        flex-direction: column;
      }
      
      .addresses, .order-summary {
        width: 100% !important;
        margin-bottom: 20px;
      }
      
      .mobile-order-summary {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: white;
        border-top: 1px solid #ddd;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        padding: 10px 15px;
        z-index: 1000;
        display: none; /* Will toggle based on screen size */
      }
      
      .mobile-summary-toggle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
      }
      
      .page-content {
        padding-bottom: 130px; /* Ensure content isn't hidden behind sticky footer */
      }
      
      .mobile-summary-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      
      .mobile-summary-details.open {
        max-height: 300px;
      }
    }
    
    .error-message {
      color: #d9534f;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    
    .disabled-button {
      background-color: #6c757d !important;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <div class="page-content">
    <h2 class="color-dark mx-3 mx-md-5 mb-3 mt-3">Checkout</h2>
    <section class="container d-md-flex justify-content-between align-items-start gap-4">
      <div class="addresses border rounded p-md-4 p-2" style="width: 65%;">
        <!-- Shipping Address Section -->
        <div class="address-section mb-4">
          <div class="address-title d-flex justify-content-between align-items-center mb-3">
            <h5 class="color-dark">Shipping address</h5>
            <button class="bg-dark rounded-2 px-3 py-1" id="addShippingAddress">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>Add address
            </button>
          </div>
          
          <div class="error-message" id="addressErrorMessage">Please select a shipping address to continue</div>
          
          <!-- Swiper for Shipping Addresses -->
          <div class="swiper shippingSwiper w-100">
            <div id="allUserAddresses" class="swiper-wrapper">
              <!-- Addresses will be loaded here -->
            </div>
          </div>
        </div>
        
        <!-- Billing Address Section -->
        <div class="billing-section">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="color-dark">Billing address</h5>
            <button class="bg-dark rounded-2 px-3 py-1" id="addBillingAddress">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>Add address
            </button>
          </div>
          
          <div class="checkbox mb-3">
            <input type="checkbox" id="sameShippingAddress" name="sameShippingAddress" checked style="width: auto; margin-right: 8px;">
            <label for="sameShippingAddress">Same as shipping address</label>
          </div>
          
          <!-- Swiper for Billing Addresses (hidden by default) -->
          <div id="billingAddressesContainer" style="display: none;">
            <div class="error-message" id="billingErrorMessage">Please select a billing address to continue</div>
            <div class="swiper billingSwiper w-100">
              <div id="billingAddresses" class="swiper-wrapper">
                <!-- Billing addresses will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Order Summary Section - Desktop -->
      <div class="order-summary d-none d-md-block" style="width: 35%;">
        <h5 class="color-dark mb-3">Order Summary</h5>
        
        <!-- Order Items -->
        <div class="order-items mb-4" id="desktopOrderItems">
          <!-- Order items will be dynamically loaded here -->
        </div>
        
        <!-- Order Calculations -->
        <div class="summary-calculations" id="desktopSummaryCalculations">
          <!-- Summary calculations will be dynamically loaded here -->
        </div>
        
        <!-- Checkout Button -->
        <button id="completeDesktopPurchase" class="w-100 bg-dark py-2 mt-3 rounded disabled-button">Complete Purchase</button>
      </div>
    </section>
  </div>
  
  <!-- Mobile Order Summary -->
  <div class="mobile-order-summary d-md-none">
    <div class="mobile-summary-toggle">
      <span>Order Summary (<span id="mobileItemCount">0</span> items)</span>
      <span class="total-price fw-bold">$0.00</span>
      <span class="toggle-icon">▲</span>
    </div>
    
    <div class="mobile-summary-details">
      <div class="order-items" id="mobileOrderItems">
        <!-- Mobile order items will be loaded here -->
      </div>
      
      <div class="summary-calculations" id="mobileSummaryCalculations">
        <!-- Mobile summary calculations will be loaded here -->
      </div>
    </div>
    
    <button id="completeMobilePurchase" class="w-100 bg-dark py-2 mt-3 rounded disabled-button">Complete Purchase</button>
  </div>

  <!-- Bootstrap and Swiper Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
 
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    // Store selected addresses
    let selectedShippingAddressId = null;
    let selectedBillingAddressId = null;
    let orderData = null;
    let total;
    
    // Function to validate address selection
    function validateAddressSelection() {
      const addressError = document.getElementById('addressErrorMessage');
      const billingError = document.getElementById('billingErrorMessage');
      const sameAsShipping = document.getElementById('sameShippingAddress').checked;
      const purchaseButtons = document.querySelectorAll('#completeDesktopPurchase, #completeMobilePurchase');
      
      // Clear previous error messages
      addressError.style.display = 'none';
      if (billingError) billingError.style.display = 'none';
      
      // Validate shipping address
      if (!selectedShippingAddressId) {
        addressError.style.display = 'block';
        purchaseButtons.forEach(btn => {
          btn.classList.add('disabled-button');
        });
        return false;
      }
      
      // Validate billing address if not same as shipping
      if (!sameAsShipping && !selectedBillingAddressId) {
        billingError.style.display = 'block';
        purchaseButtons.forEach(btn => {
          btn.classList.add('disabled-button');
        });
        return false;
      }
      
      // All validations passed
      purchaseButtons.forEach(btn => {
        btn.classList.remove('disabled-button');
      });
      return true;
    }
    



// Function to render addresses in the specified container
async function renderAddresses() {
  try {
    // Get user ID from local storage
    const userId = localStorage.getItem('user-access-id');

    if (!userId) {
      console.log("User ID not found in local storage");
      return;
    }

    // Fetch addresses from API
    const response = await fetch(`http://localhost:3000/api/address/get-address/${userId}`, {
      method: 'GET',
    });

    if (!response.ok) {
      const errorData = await response.json();
      console.log("Error fetching addresses:", errorData.message);
      return;
    }

    // Store fetched addresses in a variable
    const data = await response.json();
    const addresses = data.addresses || [];

    // Get the container
    const shippingContainer = document.getElementById('allUserAddresses');
    const billingContainer = document.getElementById('billingAddresses');

    if (!shippingContainer || !billingContainer) {
      console.log("Address containers not found");
      return;
    }

    // Clear previous content
    shippingContainer.innerHTML = '';
    billingContainer.innerHTML = '';

    // If no addresses found
    if (!addresses.length) {
      shippingContainer.innerHTML = '<div class="swiper-slide"><p class="text-muted">No addresses found. Please add a shipping address to continue.</p></div>';
      return;
    }

    // Sort addresses - default addresses first
    const sortedAddresses = [...addresses].sort((a, b) => {
      if (a.defaultAddress) return -1;
      if (b.defaultAddress) return 1;
      return 0;
    });


    // Render each address
    sortedAddresses.forEach((address, index) => {
      const addressHTML = `
        <div class="swiper-slide">
          <div class="address-card border p-3 rounded ${index === 0 ? 'selected' : ''}" data-address-id="${address.addressId}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0 gap-1 d-flex justify-content-left align-items-center fw-bold small">
                  <img src="../assets/icons/${address.addressType}.svg" alt="" /> ${address.addressType}
                </h5>
                ${address.defaultAddress ? '<span class="default-address-badge">Default</span>' : ''}
              </div>
              <p class="card-text mb-1">${address.fullName}</p>
              <p class="card-text mb-1">${address.addressLine1}</p>
              ${address.localityArea ? `<p class="card-text mb-1">${address.localityArea}</p>` : ''}
              <p class="card-text mb-1">${address.cityTown}, ${address.state} ${address.pinCode}</p>
              <p class="card-text mb-1">${address.country}</p>
              <p class="card-text mb-1">${address.mobileNumber}</p>
            </div>
          </div>
        </div>
      `;

      shippingContainer.innerHTML += addressHTML;
      billingContainer.innerHTML += addressHTML;

      // Set the first address as selected by default
      if (index === 0) {
        selectedShippingAddressId = address.addressId;
        selectedBillingAddressId = address.addressId;
      }
    });

    // Initialize Swiper for shipping addresses
    new Swiper(".shippingSwiper", {
      slidesPerView: 1,
      spaceBetween: 10,
      pagination: {
        el: ".swiper-pagination",
        clickable: true,
      },
    });

    // Address card selection
    document.querySelectorAll('#allUserAddresses .address-card').forEach(card => {
      card.addEventListener('click', function () {
        document.querySelectorAll('#allUserAddresses .address-card').forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
        selectedShippingAddressId = this.getAttribute('data-address-id');
        validateAddressSelection();
      });
    });

    // Handle checkbox for same billing address
    const sameAddressCheckbox = document.getElementById('sameShippingAddress');
    sameAddressCheckbox.addEventListener('change', function () {
      const billingContainer = document.getElementById('billingAddressesContainer');

      if (this.checked) {
        billingContainer.style.display = 'none';
        selectedBillingAddressId = selectedShippingAddressId;
      } else {
        billingContainer.style.display = 'block';
        selectedBillingAddressId = null;

        new Swiper(".billingSwiper", {
          slidesPerView: 1,
          spaceBetween: 10,
          pagination: {
            el: ".swiper-pagination",
            clickable: true,
          },
        });

        document.querySelectorAll('#billingAddresses .address-card').forEach(card => {
          card.addEventListener('click', function () {
            document.querySelectorAll('#billingAddresses .address-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            selectedBillingAddressId = this.getAttribute('data-address-id');
            validateAddressSelection();
          });
        });
      }
      validateAddressSelection();
    });

    validateAddressSelection();

  } catch (error) {
    console.log("Error rendering addresses:", error);
  }
}
 


    // Function to fetch and render order items
    async function fetchAndRenderOrderSummary(orderId) {
      try {
        
        const response = await fetch(`http://localhost:3000/api/order/${orderId}`, {
          method: 'GET',
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.log("Error fetching order data:", errorData.message);
          return;
        }

        const Data = await response.json();
        orderData = await Data.order;
        console.log("This is the order data :",orderData);
        renderOrderSummary(orderData);
        setupPurchaseButtons(orderData);
      }
      
        
        
       catch (error) {
        console.log("Error fetching order data:", error);
      }
    
    }

  // Function to render order summary
function renderOrderSummary(data) {
  const shippingCharges = 0;

  // Corrected GST function
  const GST = function getGST(itemsAmount) {
    return itemsAmount * 0.18; // Assuming GST is 18%
  };

  // Corrected Total Amount function
  const totalAmount = function getTotal(itemsAmount, gst) {
    return gst + shippingCharges + itemsAmount;
  };


  if (!data) {
    console.log("Invalid order data");
    return;
  }

  // Render order items for desktop
  const desktopOrderItems = document.getElementById('desktopOrderItems');
  desktopOrderItems.innerHTML = '';

  // Render order items for mobile
  const mobileOrderItems = document.getElementById('mobileOrderItems');
  mobileOrderItems.innerHTML = '';

  // Update mobile item count
  document.getElementById('mobileItemCount').textContent = data.OrderItems.length;

  // Render each order item
  data.OrderItems.forEach(item => {
    const itemHTML = `
      <div class="order-item">
        <img src="${item.minImage}" alt="${item.itemTitle}" class="order-item-image">
        <div class="order-item-details">
          <div class="item-name">${item.itemTitle}</div><span style="background-color: ${item.itemColor}; border-radius: 50%; width:15px; height: 15px; display: inline-block;"></span>
 / 
          ${item.orderItemVarients.map(varient => `<span>${varient.value}</span>`).join(' / ')}
          <div class="item-quantity">Qty: ${item.itemQty}</div>
        </div>
        <div class="order-item-price">₹${item.itemPrice.toFixed(2)}</div>
      </div>
    `;

    desktopOrderItems.innerHTML += itemHTML;
    mobileOrderItems.innerHTML += itemHTML;
  });

  // Render summary calculations for desktop
  const desktopSummary = document.getElementById('desktopSummaryCalculations');
  const mobileSummary = document.getElementById('mobileSummaryCalculations');

  const gstAmount = GST(data.orderAmount);
   total = totalAmount(data.orderAmount, gstAmount);

  const summaryHTML = `
    <div class="summary-row">
      <span>Subtotal (${data.OrderItems.length} items)</span>
      <span>₹${data.orderAmount}</span>
    </div>
    <div class="summary-row">
      <span>Shipping</span>
      <span>₹${shippingCharges}</span>
    </div>
    <div class="summary-row">
      <span>Tax</span>
      <span>₹${gstAmount.toFixed(2)}</span>
    </div>
    <div class="summary-row summary-total">
      <span>Total</span>
      <span>₹${total.toFixed(2)}</span>
    </div>
  `;

  desktopSummary.innerHTML = summaryHTML;
  mobileSummary.innerHTML = summaryHTML;

  // Update mobile total price
  document.querySelector('.total-price').textContent = `₹${total.toFixed(2)}`;

}

    // Function to handle mobile order summary toggle
    function setupMobileSummary() {
      const toggleElement = document.querySelector('.mobile-summary-toggle');
      const detailsElement = document.querySelector('.mobile-summary-details');
      const toggleIcon = document.querySelector('.toggle-icon');
      
      if (toggleElement && detailsElement) {
        toggleElement.addEventListener('click', function() {
          detailsElement.classList.toggle('open');
          toggleIcon.textContent = detailsElement.classList.contains('open') ? '▼' : '▲';
        });
      }
      
      // Show mobile order summary on small screens
      function handleResize() {
        const mobileSummary = document.querySelector('.mobile-order-summary');
        if (window.innerWidth < 768) {
          mobileSummary.style.display = 'block';
        } else {
          mobileSummary.style.display = 'none';
        }
      }
      
      // Initial check
      handleResize();
      
      // Listen for window resize
      window.addEventListener('resize', handleResize);
    }
    


// Handle purchase button click
function setupPurchaseButtons(data) {
  const desktopButton = document.getElementById('completeDesktopPurchase');
  const mobileButton = document.getElementById('completeMobilePurchase');

  const handlePurchase = async function () {
    // Address validation check
    if (!validateAddressSelection()) {
      showNotification("Please select a valid address.", "error");
      return;
    }

    // Define the data object for order
    const orderData = {
      orderId: data.orderId,
      orderAmount: total, // Directly using global `total`
      paymentMethod: "Online",
    };

    try {
      // Call backend API to create Razorpay Order
      const res = await fetch('http://localhost:3000/api/order/capture-payment', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(orderData),
      });

      if (!res.ok) {
        const RazorpayRES = await res.json();
        showNotification(RazorpayRES.message || "Payment initialization failed.", "error");
        return;
      }

      const RazorpayRES = await res.json();
      console.log("Razorpay data:", RazorpayRES);

      // Fetch User details
      const userRES = await fetch(`http://localhost:3000/api/auth/get-user/${localStorage.getItem('user-access-id')}`, {
        method: 'GET',
      });

      if (!userRES.ok) {
        const userError = await userRES.json();
        showNotification(userError.message || "User fetch failed.", "error");
        return;
      }

      const userData = await userRES.json();
      const User = userData.user;

      // **Trigger Razorpay Checkout**
      const options = {
        key: RazorpayRES.key, // Razorpay Key ID
        amount: RazorpayRES.amount, // amount in paise
        currency: "INR",
        name: "Mobile Shopping",
        description: "Order Checkout",
        image: "https://res.cloudinary.com/nareshgarva/image/upload/w_1000,c_fill,ar_1:1,g_auto,r_max,bo_5px_solid_red,b_rgb:262c35/v1747483963/favicon_tg1yr7.svg",
        order_id: RazorpayRES.razorpayOrderId,
        confirm_close:true,
        handler: async function (response) {
          console.log("Payment successful: ", response);

          // Call backend to update the order status
          const orderUpdateData = {
            orderAmount: total, // Global `total`
            paymentStatus: 'Paid',
            orderStatus: 'Complete',
            billingAddressId: selectedBillingAddressId, // Global variable
            shippingAddressId: selectedShippingAddressId, // Global variable
            razorpayOrderId: response.razorpay_order_id,
            razorpayPaymentId: response.razorpay_payment_id,
            razorpaySignature: response.razorpay_signature
          };

          const orderRES = await fetch(`http://localhost:3000/api/order/update_order/${data.orderId}`, {
            method: 'PUT',
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(orderUpdateData),
          });

          if (!orderRES.ok) {
            const orderError = await orderRES.json();
            showNotification(orderError.message || "Order update failed.", "error");
            return;
          }

          console.log("Order successfully updated!");
          showNotification("Payment and order update successful!", "success");
        },
        prefill: {
          name: User.name,
          email: User.email,
          contact: User.mobile,
        },
        theme: {
          color: "#000000",
        },
      };

      // Open the Razorpay Checkout modal
      const rzp1 = new Razorpay(options);
      rzp1.open();
    } catch (err) {
      console.error("Error during purchase:", err.message);
      showNotification("Payment failed. Please try again.", "error");
    }
  };

  // Attach the event listeners
  desktopButton.addEventListener('click', handlePurchase);
  mobileButton.addEventListener('click', handlePurchase);
}



    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
       // Get product ID from URL
  const urlParams = new URLSearchParams(window.location.search);
 const orderId = urlParams.get("orderId");
const userId = localStorage.getItem("user-access-id");

      renderAddresses();
      fetchAndRenderOrderSummary(orderId);
      setupMobileSummary();
      
      
      // Setup add address buttons
      document.getElementById('addShippingAddress').addEventListener('click', function() {
        // Add shipping address functionality - redirect or open modal
        alert("Add shipping address functionality would go here");
      });
      
      document.getElementById('addBillingAddress').addEventListener('click', function() {
        // Add billing address functionality - redirect or open modal
        alert("Add billing address functionality would go here");
      });
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <link rel="stylesheet" href="../css/style.css"/>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <!-- Swiper CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"
  />
  <style>
    button {
      color: white;
      outline: none;
      border: none;
    }
    
    .address-card.selected {
      border: 2px solid #000 !important;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    
    .swiper-slide {
      height: auto;
    }
    
    .address-card {
      height: 100%;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .address-card:hover {
      border-color: #aaa !important;
    }
    
    .default-address-badge {
      font-size: 12px;
      padding: 2px 6px;
      background-color: #f0f0f0;
      border-radius: 10px;
      color: #333;
    }
    
    .order-item {
      display: flex;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    
    .order-item-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      margin-right: 10px;
    }
    
    .order-item-details {
      flex-grow: 1;
    }
    
    .order-item-price {
      font-weight: bold;
      text-align: right;
    }
    
    .order-summary {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      background-color: white;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .summary-total {
      font-weight: bold;
      border-top: 1px solid #ddd;
      padding-top: 10px;
      margin-top: 10px;
    }
    
    #allUserAddresses .swiper-slide,
    #billingAddresses .swiper-slide {
      height: auto;
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 767px) {
      .container {
        flex-direction: column;
      }
      
      .addresses, .order-summary {
        width: 100% !important;
        margin-bottom: 20px;
      }
      
      .mobile-order-summary {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: white;
        border-top: 1px solid #ddd;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        padding: 10px 15px;
        z-index: 1000;
        display: none; /* Will toggle based on screen size */
      }
      
      .mobile-summary-toggle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
      }
      
      .page-content {
        padding-bottom: 130px; /* Ensure content isn't hidden behind sticky footer */
      }
      
      .mobile-summary-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      
      .mobile-summary-details.open {
        max-height: 300px;
      }
    }
    
    .error-message {
      color: #d9534f;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    
    .disabled-button {
      background-color: #6c757d !important;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <div class="page-content">
    <h2 class="color-dark mx-3 mx-md-5 mb-3 mt-3">Checkout</h2>
    <section class="container d-md-flex justify-content-between align-items-start gap-4">
      <div class="addresses border rounded p-md-4 p-2" style="width: 65%;">
        <!-- Shipping Address Section -->
        <div class="address-section mb-4">
          <div class="address-title d-flex justify-content-between align-items-center mb-3">
            <h5 class="color-dark">Shipping address</h5>
            <button class="bg-dark rounded-2 px-3 py-1" id="addShippingAddress">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>Add address
            </button>
          </div>
          
          <div class="error-message" id="addressErrorMessage">Please select a shipping address to continue</div>
          
          <!-- Swiper for Shipping Addresses -->
          <div class="swiper shippingSwiper w-100">
            <div id="allUserAddresses" class="swiper-wrapper">
              <!-- Addresses will be loaded here -->
            </div>
          </div>
        </div>
        
        <!-- Billing Address Section -->
        <div class="billing-section">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="color-dark">Billing address</h5>
            <button class="bg-dark rounded-2 px-3 py-1" id="addBillingAddress">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>Add address
            </button>
          </div>
          
          <div class="checkbox mb-3">
            <input type="checkbox" id="sameShippingAddress" name="sameShippingAddress" checked style="width: auto; margin-right: 8px;">
            <label for="sameShippingAddress">Same as shipping address</label>
          </div>
          
          <!-- Swiper for Billing Addresses (hidden by default) -->
          <div id="billingAddressesContainer" style="display: none;">
            <div class="error-message" id="billingErrorMessage">Please select a billing address to continue</div>
            <div class="swiper billingSwiper w-100">
              <div id="billingAddresses" class="swiper-wrapper">
                <!-- Billing addresses will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Order Summary Section - Desktop -->
      <div class="order-summary d-none d-md-block" style="width: 35%;">
        <h5 class="color-dark mb-3">Order Summary</h5>
        
        <!-- Order Items -->
        <div class="order-items mb-4" id="desktopOrderItems">
          <!-- Order items will be dynamically loaded here -->
        </div>
        
        <!-- Order Calculations -->
        <div class="summary-calculations" id="desktopSummaryCalculations">
          <!-- Summary calculations will be dynamically loaded here -->
        </div>
        
        <!-- Checkout Button -->
        <button id="completeDesktopPurchase" class="w-100 bg-dark py-2 mt-3 rounded disabled-button">Complete Purchase</button>
      </div>
    </section>
  </div>
  
  <!-- Mobile Order Summary -->
  <div class="mobile-order-summary d-md-none">
    <div class="mobile-summary-toggle">
      <span>Order Summary (<span id="mobileItemCount">0</span> items)</span>
      <span class="total-price fw-bold">$0.00</span>
      <span class="toggle-icon">▲</span>
    </div>
    
    <div class="mobile-summary-details">
      <div class="order-items" id="mobileOrderItems">
        <!-- Mobile order items will be loaded here -->
      </div>
      
      <div class="summary-calculations" id="mobileSummaryCalculations">
        <!-- Mobile summary calculations will be loaded here -->
      </div>
    </div>
    
    <button id="completeMobilePurchase" class="w-100 bg-dark py-2 mt-3 rounded disabled-button">Complete Purchase</button>
  </div>

  <!-- Bootstrap and Swiper Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
  
  <script>
    // Store selected addresses
    let selectedShippingAddress = null;
    let selectedBillingAddress = null;
    let orderData = null;
    
    // Function to validate address selection
    function validateAddressSelection() {
      const addressError = document.getElementById('addressErrorMessage');
      const billingError = document.getElementById('billingErrorMessage');
      const sameAsShipping = document.getElementById('sameShippingAddress').checked;
      const purchaseButtons = document.querySelectorAll('#completeDesktopPurchase, #completeMobilePurchase');
      
      // Clear previous error messages
      addressError.style.display = 'none';
      if (billingError) billingError.style.display = 'none';
      
      // Validate shipping address
      if (!selectedShippingAddress) {
        addressError.style.display = 'block';
        purchaseButtons.forEach(btn => {
          btn.classList.add('disabled-button');
        });
        return false;
      }
      
      // Validate billing address if not same as shipping
      if (!sameAsShipping && !selectedBillingAddress) {
        billingError.style.display = 'block';
        purchaseButtons.forEach(btn => {
          btn.classList.add('disabled-button');
        });
        return false;
      }
      
      // All validations passed
      purchaseButtons.forEach(btn => {
        btn.classList.remove('disabled-button');
      });
      return true;
    }
    
    // Function to render addresses in the specified container
    async function renderAddresses() {
      try {
        // Get user ID from local storage
        const userId = localStorage.getItem('user-access-id');
        
        if (!userId) {
          console.log("User ID not found in local storage");
          return;
        }
        
        // Fetch addresses from API
        const response = await fetch(`http://localhost:3000/api/address/get-address/${userId}`, {
          method: 'GET',
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.log("Error fetching addresses:", errorData.message);
          return;
        }

        // Store fetched addresses in global variable
        const data = await response.json();
        const addresses = data.addresses || [];
        console.log("Fetched addresses:", addresses);
        
        // Get the container
        const shippingContainer = document.getElementById('allUserAddresses');
        const billingContainer = document.getElementById('billingAddresses');
        
        if (!shippingContainer || !billingContainer) {
          console.log("Address containers not found");
          return;
        }
        
        // Clear previous content
        shippingContainer.innerHTML = '';
        billingContainer.innerHTML = '';

        // If no addresses found
        if (!addresses || addresses.length === 0) {
          shippingContainer.innerHTML = '<div class="swiper-slide"><p class="text-muted">No addresses found. Please add a shipping address to continue.</p></div>';
          return;
        }

        // Sort addresses - default addresses first
        const sortedAddresses = [...addresses].sort((a, b) => {
          if (a.defaultAddress) return -1;
          if (b.defaultAddress) return 1;
          return 0;
        });

        // Render each address
        sortedAddresses.forEach((address, index) => {
          const addressHTML = `
            <div class="swiper-slide">
              <div class="address-card border p-3 rounded ${index === 0 ? 'selected' : ''}" data-address-id="${address._id || index}">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0 gap-1 d-flex justify-content-left align-items-center fw-bold small">
                      <img src="../assets/icons/${address.addressType}.svg" alt="" /> ${address.addressType}
                    </h5>
                    ${address.defaultAddress ? '<span class="default-address-badge">Default</span>' : ''}
                  </div>
                  <p class="card-text mb-1">${address.fullName}</p>
                  <p class="card-text mb-1">${address.addressLine1}</p>
                  ${address.localityArea ? `<p class="card-text mb-1">${address.localityArea}</p>` : ''}
                  <p class="card-text mb-1">${address.cityTown}, ${address.state} ${address.pinCode}</p>
                  <p class="card-text mb-1">${address.country}</p>
                  <p class="card-text mb-1">${address.mobileNumber}</p>
                </div>
              </div>
            </div>
          `;
          
          shippingContainer.innerHTML += addressHTML;
          billingContainer.innerHTML += addressHTML;
        });
        
        // Initialize Swiper for shipping addresses
        setTimeout(() => {
          const shippingSwiper = new Swiper(".shippingSwiper", {
            slidesPerView: 1,
            spaceBetween: 10,
            pagination: {
              el: ".swiper-pagination",
              clickable: true,
            },
            breakpoints: {
              // Mobile
              640: {
                slidesPerView: 1,
              },
              // Tablet
              768: {
                slidesPerView: 2,
                spaceBetween: 15,
              },
              // Desktop
              1024: {
                slidesPerView: 2,
                spaceBetween: 20,
              },
            },
          });
        }, 0);
        
        // Add event listeners to shipping address cards
        document.querySelectorAll('#allUserAddresses .address-card').forEach((card, index) => {
          // Set first address as selected by default
          if (index === 0) {
            const addressId = card.getAttribute('data-address-id');
            selectedShippingAddress = sortedAddresses.find(addr => (addr._id || index) == addressId);
          }
          
          card.addEventListener('click', function() {
            // Remove selected class from all cards
            document.querySelectorAll('#allUserAddresses .address-card').forEach(c => {
              c.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            this.classList.add('selected');
            
            // Store selected address
            const addressId = this.getAttribute('data-address-id');
            selectedShippingAddress = sortedAddresses.find(addr => (addr._id || index) == addressId);
            console.log("Selected shipping address:", selectedShippingAddress);
            
            // Validate selection
            validateAddressSelection();
          });
        });
        
        // Handle checkbox for same billing address
        const sameAddressCheckbox = document.getElementById('sameShippingAddress');
        sameAddressCheckbox.addEventListener('change', function() {
          const billingContainer = document.getElementById('billingAddressesContainer');
          
          if (this.checked) {
            billingContainer.style.display = 'none';
            selectedBillingAddress = selectedShippingAddress;
          } else {
            billingContainer.style.display = 'block';
            selectedBillingAddress = null;
            
            // Initialize Swiper for billing addresses if not already initialized
            setTimeout(() => {
              const billingSwiper = new Swiper(".billingSwiper", {
                slidesPerView: 1,
                spaceBetween: 10,
                pagination: {
                  el: ".swiper-pagination",
                  clickable: true,
                },
                breakpoints: {
                  640: {
                    slidesPerView: 1,
                  },
                  768: {
                    slidesPerView: 2,
                    spaceBetween: 15,
                  },
                  1024: {
                    slidesPerView: 2,
                    spaceBetween: 20,
                  },
                },
              });
            }, 0);
            
            // Add event listeners to billing address cards
            document.querySelectorAll('#billingAddresses .address-card').forEach((card, index) => {
              card.addEventListener('click', function() {
                // Remove selected class from all billing cards
                document.querySelectorAll('#billingAddresses .address-card').forEach(c => {
                  c.classList.remove('selected');
                });
                
                // Add selected class to clicked card
                this.classList.add('selected');
                
                // Store selected billing address
                const addressId = this.getAttribute('data-address-id');
                selectedBillingAddress = sortedAddresses.find(addr => (addr._id || index) == addressId);
                console.log("Selected billing address:", selectedBillingAddress);
                
                // Validate selection
                validateAddressSelection();
              });
            });
          }
          
          // Validate selection after changing checkbox
          validateAddressSelection();
        });
        
        // Validate initial selection
        validateAddressSelection();
        
      } catch (error) {
        console.log("Error rendering addresses:", error);
      }
    }
    
    // Function to fetch and render order items
    async function fetchAndRenderOrderSummary() {
      try {
        // Get user ID from local storage
        const userId = localStorage.getItem('user-access-id');
        
        if (!userId) {
          console.log("User ID not found in local storage");
          return;
        }
        
        // Fetch order data from API - replace with your actual API endpoint
        // For demonstration, I'll simulate the data
        /* 
        const response = await fetch(`http://localhost:3000/api/orders/cart/${userId}`, {
          method: 'GET',
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.log("Error fetching order data:", errorData.message);
          return;
        }

        orderData = await response.json();
        */
        
        // Simulated order data for demonstration
        orderData = {
          items: [
            {
              id: 1,
              name: "Premium T-Shirt",
              image: "/api/placeholder/60/60",
              variant: "Size: M, Color: Blue",
              quantity: 1,
              price: 29.99
            },
            {
              id: 2,
              name: "Casual Jeans",
              image: "/api/placeholder/60/60",
              variant: "Size: 32, Color: Black",
              quantity: 1,
              price: 49.99
            },
            {
              id: 3,
              name: "Baseball Cap",
              image: "/api/placeholder/60/60",
              variant: "One Size, Color: Red",
              quantity: 1,
              price: 19.99
            }
          ],
          summary: {
            subtotal: 99.97,
            shipping: 5.99,
            tax: 8.00,
            total: 113.96
          }
        };
        
        renderOrderSummary(orderData);
        
      } catch (error) {
        console.log("Error fetching order data:", error);
      }
    }
    
    // Function to render order summary
    function renderOrderSummary(data) {
      if (!data || !data.items || !data.summary) {
        console.log("Invalid order data");
        return;
      }
      
      // Render order items for desktop
      const desktopOrderItems = document.getElementById('desktopOrderItems');
      desktopOrderItems.innerHTML = '';
      
      // Render order items for mobile
      const mobileOrderItems = document.getElementById('mobileOrderItems');
      mobileOrderItems.innerHTML = '';
      
      // Update mobile item count
      document.getElementById('mobileItemCount').textContent = data.items.length;
      
      // Render each order item
      data.items.forEach(item => {
        const itemHTML = `
          <div class="order-item">
            <img src="${item.image}" alt="${item.name}" class="order-item-image">
            <div class="order-item-details">
              <div class="item-name">${item.name}</div>
              <div class="item-variant">${item.variant}</div>
              <div class="item-quantity">Qty: ${item.quantity}</div>
            </div>
            <div class="order-item-price">$${item.price.toFixed(2)}</div>
          </div>
        `;
        
        desktopOrderItems.innerHTML += itemHTML;
        mobileOrderItems.innerHTML += itemHTML;
      });
      
      // Render summary calculations for desktop
      const desktopSummary = document.getElementById('desktopSummaryCalculations');
      const mobileSummary = document.getElementById('mobileSummaryCalculations');
      
      const summaryHTML = `
        <div class="summary-row">
          <span>Subtotal (${data.items.length} items)</span>
          <span>$${data.summary.subtotal.toFixed(2)}</span>
        </div>
        <div class="summary-row">
          <span>Shipping</span>
          <span>$${data.summary.shipping.toFixed(2)}</span>
        </div>
        <div class="summary-row">
          <span>Tax</span>
          <span>$${data.summary.tax.toFixed(2)}</span>
        </div>
        <div class="summary-row summary-total">
          <span>Total</span>
          <span>$${data.summary.total.toFixed(2)}</span>
        </div>
      `;
      
      desktopSummary.innerHTML = summaryHTML;
      mobileSummary.innerHTML = summaryHTML;
      
      // Update mobile total price
      document.querySelector('.total-price').textContent = `$${data.summary.total.toFixed(2)}`;
    }
    
    // Function to handle mobile order summary toggle
    function setupMobileSummary() {
      const toggleElement = document.querySelector('.mobile-summary-toggle');
      const detailsElement = document.querySelector('.mobile-summary-details');
      const toggleIcon = document.querySelector('.toggle-icon');
      
      if (toggleElement && detailsElement) {
        toggleElement.addEventListener('click', function() {
          detailsElement.classList.toggle('open');
          toggleIcon.textContent = detailsElement.classList.contains('open') ? '▼' : '▲';
        });
      }
      
      // Show mobile order summary on small screens
      function handleResize() {
        const mobileSummary = document.querySelector('.mobile-order-summary');
        if (window.innerWidth < 768) {
          mobileSummary.style.display = 'block';
        } else {
          mobileSummary.style.display = 'none';
        }
      }
      
      // Initial check
      handleResize();
      
      // Listen for window resize
      window.addEventListener('resize', handleResize);
    }
    
    // Handle purchase button click
    function setupPurchaseButtons() {
      const desktopButton = document.getElementById('completeDesktopPurchase');
      const mobileButton = document.getElementById('completeMobilePurchase');
      
      const handlePurchase = function() {
        if (!validateAddressSelection()) {
          return;
        }
        
        // Processing logic here...
        console.log("Processing purchase with:", {
          shippingAddress: selectedShippingAddress,
          billingAddress: selectedBillingAddress || selectedShippingAddress,
          orderData: orderData
        });
        
        alert("Thank you for your purchase!");
      };
      
      desktopButton.addEventListener('click', handlePurchase);
      mobileButton.addEventListener('click', handlePurchase);
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      renderAddresses();
      fetchAndRenderOrderSummary();
      setupMobileSummary();
      setupPurchaseButtons();
      
      // Setup add address buttons
      document.getElementById('addShippingAddress').addEventListener('click', function() {
        // Add shipping address functionality - redirect or open modal
        alert("Add shipping address functionality would go here");
      });
      
      document.getElementById('addBillingAddress').addEventListener('click', function() {
        // Add billing address functionality - redirect or open modal
        alert("Add billing address functionality would go here");
      });
    });
  </script>
</body>
</html>